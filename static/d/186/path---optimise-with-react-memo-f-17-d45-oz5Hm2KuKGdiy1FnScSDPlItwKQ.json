{"data":{"site":{"siteMetadata":{"title":"Lecstor's Blog","author":"Jason Galea"}},"markdownRemark":{"id":"74994162-6393-5471-b90e-c21baf2a91d6","excerpt":"Takeaway: keep your memoed components focussed and their props shallow, and prefer simple solutions over complexity. skip to  the flip The…","html":"<p>Takeaway: keep your memoed components focussed and their props shallow, and prefer simple solutions over complexity. skip to <a href=\"#the-flip\">the flip</a></p>\n<p>The first step to voiding unnessary renders is to use <code class=\"language-text\">PureComponent</code> (for class components) or <code class=\"language-text\">React.memo</code> (for function components). The second step is to ensure their props don’t look like they’ve changed even when they haven’t. ie <code class=\"language-text\">map</code>, <code class=\"language-text\">filter</code>, and many of their friends will return a new object every time, even if it’s contents are the same. You might use them in your component, in Redux selectors, or elsewhere in your codebase and they’ll trip up some of React &#x26; Redux’s in-built optimisations if not handled correctly.</p>\n<p>While working on an app that deals with schedules I hit an issue where my controlled input for the schedule name was slow as molasses because each change to an input triggered a render of components which took the schedule as a prop and did much date parsing and formatting for the schedule form and summary display.</p>\n<p><strong>NP: I flip near the end of this post and replace this solution with a simple props change</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> React<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> memo <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"react\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> ScheduleEditor <span class=\"token operator\">=</span> <span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">ScheduleEditor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> schedule<span class=\"token punctuation\">,</span> onChange <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ScheduleSummary <span class=\"token operator\">=</span> <span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">ScheduleSummary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> schedule <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>schedule<span class=\"token punctuation\">,</span> setSchedule<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>initSchedule<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> updateSchedule <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n    props <span class=\"token operator\">=></span> <span class=\"token function\">setSchedule</span><span class=\"token punctuation\">(</span>schedule <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>schedule<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>props <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">updateName</span> <span class=\"token operator\">=</span> e <span class=\"token operator\">=></span> <span class=\"token function\">updateSchedule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>input value<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>schedule<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span> onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>updateName<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>ScheduleSummary schedule<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>schedule<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>ScheduleEditor schedule<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>schedule<span class=\"token punctuation\">}</span> onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>updateSchedule<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The editor and summary don’t actually do anything with the schedule name so my first move was to give them a reduced schedule object, removing the <code class=\"language-text\">name</code> property and others.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">getMinSchedule</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>schedule<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> end<span class=\"token punctuation\">,</span> recurring<span class=\"token punctuation\">,</span> rrule<span class=\"token punctuation\">,</span> start <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> schedule<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> end<span class=\"token punctuation\">,</span> recurring<span class=\"token punctuation\">,</span> rrule<span class=\"token punctuation\">,</span> start <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">...</span>\n  <span class=\"token keyword\">const</span> minSchedule <span class=\"token operator\">=</span> <span class=\"token function\">getMinSchedule</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n      <span class=\"token operator\">&lt;</span>ScheduleSummary schedule<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>minSchedule<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>ScheduleEditor schedule<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>minSchedule<span class=\"token punctuation\">}</span> onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>updateSchedule<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre></div>\n<p>Of course now I’m creating a new schedule object on each render so <code class=\"language-text\">memo</code> lets the component render every time, regardless of whether or not there have been any changes.</p>\n<p>I’ve hit similar issues with Redux selectors before and the answer there is <a href=\"https://github.com/reduxjs/reselect\">Reselect</a> which provides memoisation for selectors. I’d also used <a href=\"https://github.com/sindresorhus/mem\">mem</a> in another part of the app so <em>naturally</em> I figured I’d just use that to cache the altered schedule objects and pass them to my components. </p>\n<p>I realised this clever little nugget would do what I wanted. It will hand back a cached object matching the object passed (after the first time) so memo will see the prop as not having changed.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> mem <span class=\"token keyword\">from</span> <span class=\"token string\">\"mem\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> memProp <span class=\"token operator\">=</span> <span class=\"token function\">mem</span><span class=\"token punctuation\">(</span>obj <span class=\"token operator\">=></span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I used that and lodash.pick to replace my previous <code class=\"language-text\">getMinSchedule</code> function. (<code class=\"language-text\">pick</code> vs a custom func is definitely purely down to preference)</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> pick <span class=\"token keyword\">from</span> <span class=\"token string\">\"lodash.pick\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getMinSchedule</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">memProp</span><span class=\"token punctuation\">(</span><span class=\"token function\">pick</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"recurring\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rrule\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now my input field was back to behaving properly and everything was good. I made a <a href=\"https://codesandbox.io/s/0ylovpzy30\">codesandbox</a> for a future write-up and grabbed a coffee before continuing.</p>\n<h2 id=\"the-flip\"><a href=\"#the-flip\" aria-label=\"the flip permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The flip</h2>\n<p>So now all those puzzle-solving pleasure chemicals in my brain had subsided I took another look at the solution. While I’d only added 4 lines to my code I had added a decent amount of complexity (and invisible processing) to solve a problem that can be solved with a change to how we handle our props.</p>\n<p>Time to revisit the solution I considered initially but rejected based on the fact that I thought it was unpleasant..</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> ScheduleEditor <span class=\"token operator\">=</span> <span class=\"token function\">memo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">ScheduleEditor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">,</span> rrule<span class=\"token punctuation\">,</span> recurring<span class=\"token punctuation\">,</span> onChange <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ScheduleSummary <span class=\"token operator\">=</span> <span class=\"token function\">memo</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">ScheduleSummary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">,</span> rrule<span class=\"token punctuation\">,</span> recurring <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Schedule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token operator\">...</span>\n  <span class=\"token keyword\">const</span> minSchedule <span class=\"token operator\">=</span> <span class=\"token function\">pick</span><span class=\"token punctuation\">(</span>schedule<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"recurring\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rrule\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n      <span class=\"token operator\">&lt;</span>ScheduleSummary <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>minSchedule<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>ScheduleEditor <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>minSchedule<span class=\"token punctuation\">}</span> onChange<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>updateSchedule<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Simpler solution, same result.</p>\n<blockquote>\n<p>Urgh! all those props mixed in together. What if I have a lot more object props? What if I have more “non-object” props? what a mess!</p>\n</blockquote>\n<p>Well, no, not really. Worst case I could put all the extra props in an object or two and pass them in as <code class=\"language-text\">tools</code> or <code class=\"language-text\">flags</code> or whatever suits. But really it comes back to getting the component structure right. Small, focussed components shouldn’t have so many props, tools, or flags that this would be a big issue and make render optimisations that much easier. And for deeper component trees we can use Redux, or now React Context, to avoid components having to pass through props they don’t use.</p>\n<p><em>KISS</em></p>","frontmatter":{"title":"Optimising with React.memo","date":"March 21, 2019"}}},"pageContext":{"slug":"/optimise-with-react-memo/","previous":{"fields":{"slug":"/gcf-to-appengine/"},"frontmatter":{"title":"A Journey from Google Cloud Functions to Appengine Flex"}},"next":{"fields":{"slug":"/notes-optimizing-for-iteration-speed/"},"frontmatter":{"title":"Optimizing for iteration speed"}}}}